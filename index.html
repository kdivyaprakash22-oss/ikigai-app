<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Discover your ikigai and live with purpose - Cloud-powered app">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ikigai">
    <link rel="manifest" href="manifest.json">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <title>Ikigai Journey - Premium Available</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p { font-size: 0.95em; opacity: 0.9; }

        .user-header {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .user-info { color: #333; font-weight: 600; }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            margin-bottom: 15px;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .card h3 {
            color: #555;
            margin: 15px 0 10px 0;
            font-size: 1.05em;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .nav-tab {
            padding: 10px 15px;
            background: white;
            border: none;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9em;
        }

        .form-group textarea {
            min-height: 50px;
            resize: vertical;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .item-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 6px;
        }

        .item-name { font-weight: 600; margin-bottom: 4px; }
        .item-meta { color: #666; font-size: 0.85em; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number { font-size: 1.8em; font-weight: bold; margin-bottom: 4px; }
        .stat-label { font-size: 0.8em; opacity: 0.9; }

        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .success {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        #auth-screen { display: block; }
        #app-screen { display: none; }

        .auth-container {
            max-width: 400px;
            margin: 50px auto;
        }

        .premium-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .pricing-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .pricing-card.featured {
            border: 2px solid #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        .price { font-size: 2.5em; font-weight: bold; color: #667eea; margin: 10px 0; }
        .price-period { color: #999; font-size: 0.9em; }

        .features-list { text-align: left; margin: 20px 0; font-size: 0.9em; }
        .features-list li { padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .features-list li:before { content: "‚úì "; color: #51cf66; font-weight: bold; margin-right: 8px; }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid #e0e0e0;
            color: #999;
            font-size: 0.9em;
            background: white;
            border-radius: 12px;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
            margin: 0 10px;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 600px) {
            header h1 { font-size: 1.5em; }
            .nav-tabs { grid-template-columns: repeat(3, 1fr); }
            .user-header { flex-direction: column; align-items: flex-start; }
            .pricing-card.featured { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- AUTH SCREEN -->
        <div id="auth-screen" class="auth-container">
            <div class="card">
                <h2>üå∏ Ikigai Journey</h2>
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                    Discover your purpose and live with intention. 
                    <br><br>
                    <strong>Cloud-powered app:</strong> Your data is synced across all devices!
                </p>

                <div id="auth-message"></div>

                <div class="form-group">
                    <label>üìß Email</label>
                    <input type="email" id="email-input" placeholder="you@example.com">
                </div>

                <div class="form-group">
                    <label>üîê Password</label>
                    <input type="password" id="password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button class="btn-primary" onclick="signup()" style="width: 100%; margin-bottom: 10px;">‚ú® Sign Up</button>
                <button class="btn-secondary" onclick="login()" style="width: 100%; margin-bottom: 15px;">üîì Login</button>

                <hr style="margin: 15px 0;">

                <button class="btn-secondary" onclick="signInWithGoogle()" style="width: 100%;">üîê Sign In with Google</button>

                <p style="color: #999; font-size: 0.8em; margin-top: 15px; text-align: center;">
                    ‚úÖ All data is encrypted and stored securely in Firebase
                </p>
            </div>
        </div>

        <!-- APP SCREEN -->
        <div id="app-screen">
            <header>
                <h1>
                    üå∏ Ikigai Journey
                    <span class="premium-badge" id="premium-badge" style="display: none;">üíé PREMIUM</span>
                </h1>
                <p style="color: white; margin-top: 5px;">Your Purpose, Cloud-Powered</p>
            </header>

            <div class="user-header">
                <div class="user-info">
                    üë§ <span id="user-email"></span>
                    <p id="subscription-status" style="color: #666; font-size: 0.9em; margin-top: 5px;"></p>
                </div>
                <div>
                    <button class="btn-secondary" onclick="enableNotifications()" style="margin-right: 10px;">üîî Notifications</button>
                    <button class="btn-secondary" onclick="logout();">üö™ Logout</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('discover')">üéØ Discover</button>
                <button class="nav-tab" onclick="switchTab('activities')">üìÖ Activities</button>
                <button class="nav-tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="nav-tab" onclick="switchTab('premium')">üíé Premium</button>
            </div>

            <!-- DISCOVER TAB -->
            <div id="discover" class="section active">
                <div class="card">
                    <h2>üå∏ Discover Your Ikigai</h2>
                    <p style="color: #666; margin-bottom: 15px;">Answer these 4 questions to find your unique purpose.</p>

                    <form onsubmit="saveIkigai(event)">
                        <div class="form-group">
                            <label>‚ù§Ô∏è What do you LOVE?</label>
                            <textarea id="love" placeholder="Your passions, hobbies..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>‚≠ê What are you GOOD AT?</label>
                            <textarea id="good" placeholder="Your talents, skills..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>üåç What does the WORLD NEED?</label>
                            <textarea id="need" placeholder="Your contribution to society..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>üí∞ What can you be PAID FOR?</label>
                            <textarea id="paid" placeholder="Monetizable skills..." required></textarea>
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%;">‚ú® Save Ikigai to Cloud</button>
                    </form>

                    <div id="ikigai-result" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <div class="message success">
                            <strong>‚úÖ Your Ikigai Saved to Cloud!</strong>
                        </div>
                        <div id="ikigai-display" style="line-height: 1.8; color: #555;"></div>
                    </div>
                </div>
            </div>

            <!-- ACTIVITIES TAB -->
            <div id="activities" class="section">
                <div class="card">
                    <h2>üìÖ Log Your Activities</h2>

                    <div class="form-group">
                        <label>üéØ Activity Name</label>
                        <input type="text" id="activity-name" placeholder="e.g., Meditation, Programming, Exercise">
                    </div>

                    <div class="form-group">
                        <label>‚è±Ô∏è Duration (minutes)</label>
                        <input type="number" id="activity-duration" placeholder="30" min="1">
                    </div>

                    <button class="btn-primary" onclick="addActivity()" style="width: 100%;">‚ûï Log Activity</button>

                    <h3 style="margin-top: 20px;">üìã Recent Activities</h3>
                    <div id="activities-list" class="item-grid">
                        <p style="color: #999; grid-column: 1/-1;">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="section">
                <div class="card">
                    <h2>üìä Your Dashboard</h2>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-number" id="activity-count">0</div>
                            <div class="stat-label">Activities Logged</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="total-minutes">0</div>
                            <div class="stat-label">Total Minutes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="avg-activity">0</div>
                            <div class="stat-label">Avg Per Activity</div>
                        </div>
                    </div>

                    <h3>üíæ Data Management</h3>
                    <button class="btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 10px;">üì• Download My Data</button>
                    <button class="btn-danger" onclick="deleteAllData()" style="width: 100%;">üóëÔ∏è Delete All Data</button>
                </div>
            </div>

            <!-- PREMIUM TAB -->
            <div id="premium" class="section">
                <div class="card">
                    <h2>üíé Go Premium!</h2>
                    <p style="color: #666; margin-bottom: 20px;">Support the app and unlock amazing features!</p>

                    <div class="pricing-grid">
                        <!-- FREE -->
                        <div class="pricing-card">
                            <h3>üéØ Free</h3>
                            <div class="price">‚Çπ0<span class="price-period">/month</span></div>
                            <ul class="features-list">
                                <li>Basic Tracking</li>
                                <li>Cloud Sync</li>
                                <li>Export Data</li>
                            </ul>
                        </div>

                        <!-- PREMIUM -->
                        <div class="pricing-card featured">
                            <h3>‚ú® Premium</h3>
                            <div class="price">‚Çπ499<span class="price-period">/month</span></div>
                            <ul class="features-list">
                                <li>Everything in Free</li>
                                <li>ü§ñ AI Coaching</li>
                                <li>üìà Analytics</li>
                                <li>üîî Notifications</li>
                            </ul>
                            <button class="btn-primary" id="subscribe-btn" onclick="startPayment()" style="margin-top: 15px;">üöÄ Upgrade Now</button>
                        </div>
                    </div>

                    <div id="payment-message" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer>
            <p>
                <a href="https://razorpay.com/" target="_blank">Terms & Conditions</a> | 
                <a href="https://razorpay.com/" target="_blank">Privacy Policy</a> | 
                <a href="https://razorpay.com/" target="_blank">Refund Policy</a> | 
                <a href="https://razorpay.com/" target="_blank">Contact Us</a>
            </p>
            <p>¬© 2025 Ikigai Journey. All rights reserved.</p>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <!-- Your Firebase Config -->
    <script src="firebase-config.js"></script>
    <!-- Your Razorpay Config -->
    <script src="razorpay-config.js"></script>

    <script>
        let auth, db, messaging, userId = null;

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                loadUserData();
                loadActivities();
                checkPremium();
                setupNotifications();
            } else {
                userId = null;
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        // ========== AUTHENTICATION ==========
        function signup() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                showMessage('‚ùå Please enter email and password', 'error');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    showMessage('‚úÖ Account created! Welcome to Ikigai!', 'success');
                    document.getElementById('email-input').value = '';
                    document.getElementById('password-input').value = '';
                })
                .catch(error => {
                    showMessage('‚ùå ' + error.message, 'error');
                });
        }

        function login() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                showMessage('‚ùå Please enter email and password', 'error');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    showMessage('‚úÖ Logged in successfully!', 'success');
                    document.getElementById('email-input').value = '';
                    document.getElementById('password-input').value = '';
                })
                .catch(error => {
                    showMessage('‚ùå ' + error.message, 'error');
                });
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    showMessage('‚úÖ Signed in with Google!', 'success');
                })
                .catch(error => {
                    showMessage('‚ùå ' + error.message, 'error');
                });
        }

        function logout() {
            auth.signOut().then(() => {
                showMessage('‚úÖ Logged out!', 'success');
            });
        }

        function showMessage(msg, type) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.innerHTML = `<div class="message ${type}">${msg}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // ========== FIRESTORE OPERATIONS ==========
        async function saveIkigai(event) {
            event.preventDefault();
            if (!userId) return alert('You must be logged in!');

            const ikigaiData = {
                love: document.getElementById('love').value,
                good: document.getElementById('good').value,
                need: document.getElementById('need').value,
                paid: document.getElementById('paid').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').doc(userId).set({ ikigai: ikigaiData }, { merge: true });

                document.getElementById('ikigai-display').innerHTML = `
                    <strong>‚ù§Ô∏è Your Passion:</strong> ${ikigaiData.love}<br><br>
                    <strong>‚≠ê Your Talent:</strong> ${ikigaiData.good}<br><br>
                    <strong>üåç Your Mission:</strong> ${ikigaiData.need}<br><br>
                    <strong>üíº Your Vocation:</strong> ${ikigaiData.paid}
                `;
                document.getElementById('ikigai-result').style.display = 'block';

                alert('‚úÖ Ikigai saved to the cloud! Access it from any device!');
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function loadUserData() {
            if (!userId) return;

            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists && doc.data().ikigai) {
                    const ikigai = doc.data().ikigai;
                    document.getElementById('love').value = ikigai.love || '';
                    document.getElementById('good').value = ikigai.good || '';
                    document.getElementById('need').value = ikigai.need || '';
                    document.getElementById('paid').value = ikigai.paid || '';

                    document.getElementById('ikigai-display').innerHTML = `
                        <strong>‚ù§Ô∏è Your Passion:</strong> ${ikigai.love}<br><br>
                        <strong>‚≠ê Your Talent:</strong> ${ikigai.good}<br><br>
                        <strong>üåç Your Mission:</strong> ${ikigai.need}<br><br>
                        <strong>üíº Your Vocation:</strong> ${ikigai.paid}
                    `;
                    document.getElementById('ikigai-result').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // ========== ACTIVITIES ==========
        async function addActivity() {
            if (!userId) return alert('You must be logged in!');

            const name = document.getElementById('activity-name').value;
            const duration = document.getElementById('activity-duration').value;

            if (!name || !duration) {
                alert('‚ùå Please fill all fields!');
                return;
            }

            try {
                await db.collection('users').doc(userId).collection('activities').add({
                    name: name,
                    duration: parseInt(duration),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('activity-name').value = '';
                document.getElementById('activity-duration').value = '';
                loadActivities();
                alert('‚úÖ Activity logged to cloud!');
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function loadActivities() {
            if (!userId) return;

            try {
                const snapshot = await db.collection('users').doc(userId).collection('activities')
                    .orderBy('createdAt', 'desc').limit(20).get();

                const activities = [];
                snapshot.forEach(doc => {
                    activities.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                const html = activities.map(activity => `
                    <div class="item-card">
                        <div class="item-name">${activity.name}</div>
                        <div class="item-meta">‚è±Ô∏è ${activity.duration} minutes</div>
                    </div>
                `).join('');

                document.getElementById('activities-list').innerHTML = html || '<p style="color: #999;">No activities yet. Start logging!</p>';
                document.getElementById('activity-count').textContent = activities.length;
                document.getElementById('total-minutes').textContent = activities.reduce((sum, a) => sum + a.duration, 0);
                document.getElementById('avg-activity').textContent = activities.length > 0
                    ? Math.round(activities.reduce((sum, a) => sum + a.duration, 0) / activities.length)
                    : 0;
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        // ========== PREMIUM & RAZORPAY ==========
        async function checkPremium() {
            if (!userId) return;

            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists && doc.data().premium) {
                    document.getElementById('premium-badge').style.display = 'inline-block';
                    document.getElementById('subscription-status').textContent = 'üíé Premium Member';
                    document.getElementById('subscribe-btn').textContent = '‚úì Already Premium';
                    document.getElementById('subscribe-btn').disabled = true;
                } else {
                    document.getElementById('subscription-status').textContent = 'üìå Free Plan - Upgrade to Premium';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function startPayment() {
            if (!userId) return alert('Please login first!');

            try {
                const options = {
                    key: RAZORPAY_KEY_ID,
                    amount: 49900, // ‚Çπ499 in paise
                    currency: 'INR',
                    name: 'Ikigai Journey',
                    description: 'Premium Monthly Subscription',
                    handler: async function(response) {
                        // Payment successful
                        console.log('Payment Success:', response);

                        // Save to Firebase
                        await db.collection('users').doc(userId).set({
                            premium: true,
                            premiumSince: firebase.firestore.FieldValue.serverTimestamp(),
                            razorpayPaymentId: response.razorpay_payment_id,
                            razorpayOrderId: response.razorpay_order_id
                        }, { merge: true });

                        alert('üéâ Welcome to Premium!\n\nYour payment was successful!\n\nYou now have access to all premium features!');
                        checkPremium();
                    },
                    prefill: {
                        email: document.getElementById('user-email').textContent,
                        contact: '9999999999'
                    },
                    theme: {
                        color: '#667eea'
                    }
                };

                const rzp1 = new Razorpay(options);
                rzp1.open();

            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ========== NOTIFICATIONS ==========
        function setupNotifications() {
            if ('serviceWorker' in navigator && typeof VAPID_KEY !== 'undefined') {
                messaging = firebase.messaging();

                messaging.getToken({ vapidKey: VAPID_KEY })
                    .then(token => {
                        console.log('‚úÖ FCM Token obtained:', token.substring(0, 20) + '...');
                        if (userId) {
                            db.collection('users').doc(userId).set({ fcmToken: token }, { merge: true });
                        }
                    })
                    .catch(err => console.log('Token error:', err));

                // Handle foreground messages
                messaging.onMessage(payload => {
                    console.log('üì¢ Foreground message:', payload);
                    if (payload.notification) {
                        alert(payload.notification.title + ': ' + payload.notification.body);
                    }
                });
            }
        }

        function enableNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        alert('‚úÖ Notifications enabled! You will receive reminders!');
                        setupNotifications();
                    } else {
                        alert('‚ùå Notifications disabled. You can enable them later in browser settings.');
                    }
                });
            } else {
                alert('‚ùå Notifications not supported in this browser.');
            }
        }

        // ========== DATA MANAGEMENT ==========
        async function exportData() {
            if (!userId) return alert('You must be logged in!');

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const activitiesSnapshot = await db.collection('users').doc(userId).collection('activities').get();

                const data = {
                    user: userDoc.data() || {},
                    activities: activitiesSnapshot.docs.map(doc => doc.data()),
                    exportDate: new Date().toLocaleString()
                };

                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ikigai-data-${new Date().toISOString().split('T')}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert('‚úÖ Your data has been downloaded!');
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteAllData() {
            if (!userId) return alert('You must be logged in!');

            if (!confirm('‚ö†Ô∏è Are you sure? This will DELETE all your data permanently!')) return;

            try {
                const batch = db.batch();
                const activitiesSnapshot = await db.collection('users').doc(userId).collection('activities').get();

                activitiesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                batch.delete(db.collection('users').doc(userId));
                await batch.commit();

                alert('‚úÖ All your data has been deleted.');
                logout();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ========== UI FUNCTIONS ==========
        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('‚úÖ Service Worker registered'))
                .catch(err => console.log('SW error:', err));
        }
    </script>
</body>
</html>
