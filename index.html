<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Discover your ikigai - Purpose-driven wellness app">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Ikigai Journey - Find Your Purpose</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-header {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .streak-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e72 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .nav-tab {
            padding: 10px 15px;
            background: white;
            border: none;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number { font-size: 1.8em; font-weight: bold; }
        .stat-label { font-size: 0.8em; opacity: 0.9; margin-top: 5px; }

        .activity-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .category-btn {
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .category-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin: 5px;
        }

        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .success {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid #e0e0e0;
            color: #999;
            font-size: 0.9em;
            background: white;
            border-radius: 12px;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
            margin: 0 10px;
        }

        #auth-screen { display: block; }
        #app-screen { display: none; }

        .auth-container {
            max-width: 400px;
            margin: 50px auto;
        }

        @media (max-width: 600px) {
            header h1 { font-size: 1.5em; }
            .nav-tabs { grid-template-columns: repeat(2, 1fr); }
            .user-header { flex-direction: column; align-items: flex-start; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- AUTH SCREEN -->
        <div id="auth-screen" class="auth-container">
            <div class="card">
                <h2>ğŸŒ¸ Ikigai Journey</h2>
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                    Discover your purpose and live with intention. 
                    <br><br>
                    <strong>Cloud-powered wellness app:</strong> Your data synced everywhere!
                </p>

                <div id="auth-message"></div>

                <div class="form-group">
                    <label>ğŸ“§ Email</label>
                    <input type="email" id="email-input" placeholder="you@example.com">
                </div>

                <div class="form-group">
                    <label>ğŸ” Password</label>
                    <input type="password" id="password-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>

                <button class="btn-primary" onclick="signup()" style="width: 100%; margin-bottom: 10px;">âœ¨ Sign Up</button>
                <button class="btn-secondary" onclick="login()" style="width: 100%; margin-bottom: 15px;">ğŸ”“ Login</button>

                <p style="color: #999; font-size: 0.8em; margin-top: 15px; text-align: center;">
                    âœ… All data encrypted & stored securely in Firebase
                </p>
            </div>
        </div>

        <!-- APP SCREEN -->
        <div id="app-screen">
            <header>
                <h1>ğŸŒ¸ Ikigai Journey</h1>
            </header>

            <div class="user-header">
                <div>
                    <div style="font-weight: 600;">ğŸ‘¤ <span id="user-email"></span></div>
                    <div class="streak-badge" id="streak-display">ğŸ”¥ Streak: 0</div>
                </div>
                <div>
                    <button class="btn-secondary" onclick="switchTab('profile')" style="margin-right: 10px;">ğŸ‘¤ Profile</button>
                    <button class="btn-secondary" onclick="logout();">ğŸšª Logout</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('discover')">ğŸ¯ Discover</button>
                <button class="nav-tab" onclick="switchTab('activities')">ğŸ“… Activities</button>
                <button class="nav-tab" onclick="switchTab('stats')">ğŸ“Š Stats</button>
                <button class="nav-tab" onclick="switchTab('profile')">ğŸ‘¤ Profile</button>
                <button class="nav-tab" onclick="switchTab('premium')">ğŸ’ Premium</button>
            </div>

            <!-- DISCOVER TAB -->
            <div id="discover" class="section active">
                <div class="card">
                    <h2>ğŸŒ¸ Discover Your Ikigai</h2>
                    <p style="color: #666; margin-bottom: 15px;">Answer 4 powerful questions to find your unique purpose.</p>

                    <form onsubmit="saveIkigai(event)">
                        <div class="form-group">
                            <label>â¤ï¸ What do you LOVE?</label>
                            <textarea id="love" placeholder="Your passions, hobbies..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>â­ What are you GOOD AT?</label>
                            <textarea id="good" placeholder="Your talents, skills..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>ğŸŒ What does the WORLD NEED?</label>
                            <textarea id="need" placeholder="Your contribution to society..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>ğŸ’° What can you be PAID FOR?</label>
                            <textarea id="paid" placeholder="Monetizable skills..." required></textarea>
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%;">âœ¨ Save Ikigai</button>
                    </form>

                    <div id="ikigai-result" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <div class="message success">
                            <strong>âœ… Your Ikigai Saved to Cloud!</strong>
                        </div>
                        <div id="ikigai-display" style="line-height: 1.8; color: #555;"></div>
                    </div>
                </div>
            </div>

            <!-- ACTIVITIES TAB -->
            <div id="activities" class="section">
                <div class="card">
                    <h2>ğŸ“… Log Your Activities</h2>

                    <div class="form-group">
                        <label>ğŸ“‚ Select Category</label>
                        <div class="category-selector">
                            <button type="button" class="category-btn" onclick="selectCategory('Health', this)">ğŸ’ª Health</button>
                            <button type="button" class="category-btn" onclick="selectCategory('Work', this)">ğŸ’¼ Work</button>
                            <button type="button" class="category-btn" onclick="selectCategory('Learning', this)">ğŸ“š Learning</button>
                            <button type="button" class="category-btn" onclick="selectCategory('Hobby', this)">ğŸ¨ Hobby</button>
                            <button type="button" class="category-btn" onclick="selectCategory('Social', this)">ğŸ‘¥ Social</button>
                            <button type="button" class="category-btn" onclick="selectCategory('Other', this)">â­ Other</button>
                        </div>
                        <input type="hidden" id="selected-category" value="">
                    </div>

                    <div class="form-group">
                        <label>ğŸ¯ Activity Name</label>
                        <input type="text" id="activity-name" placeholder="e.g., Morning Yoga, Coding">
                    </div>

                    <div class="form-group">
                        <label>â±ï¸ Duration (minutes)</label>
                        <input type="number" id="activity-duration" placeholder="30" min="1">
                    </div>

                    <button class="btn-primary" onclick="addActivity()" style="width: 100%;">â• Log Activity</button>

                    <h3 style="margin-top: 20px;">ğŸ“‹ Recent Activities</h3>
                    <div id="activities-list"></div>
                </div>
            </div>

            <!-- STATS TAB -->
            <div id="stats" class="section">
                <div class="card">
                    <h2>ğŸ“Š Your Statistics</h2>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-number" id="activity-count">0</div>
                            <div class="stat-label">Activities</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="total-minutes">0</div>
                            <div class="stat-label">Total Minutes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="avg-activity">0</div>
                            <div class="stat-label">Avg/Activity</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="daily-avg">0</div>
                            <div class="stat-label">Daily Avg</div>
                        </div>
                    </div>

                    <h3>ğŸ“ˆ Weekly Activity Chart</h3>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>

                    <h3>ğŸ“‚ Category Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="profile" class="section">
                <div class="card">
                    <h2>ğŸ‘¤ Your Profile</h2>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-number" id="profile-days">0</div>
                            <div class="stat-label">Days Member</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="profile-streak">0</div>
                            <div class="stat-label">Current Streak ğŸ”¥</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="profile-best">0</div>
                            <div class="stat-label">Best Streak</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="profile-badges">0</div>
                            <div class="stat-label">Achievements</div>
                        </div>
                    </div>

                    <h3>ğŸ† Your Achievements</h3>
                    <div id="achievements-list" style="margin: 15px 0;"></div>

                    <h3>â­ Motivational Quote</h3>
                    <p id="daily-quote" style="font-style: italic; color: #667eea; padding: 15px; background: #f0f2f5; border-radius: 8px; margin: 15px 0;"></p>

                    <h3>ğŸ’¾ Account Management</h3>
                    <button class="btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 10px;">ğŸ“¥ Export My Data</button>
                    <button class="btn-danger" onclick="deleteAllData()" style="width: 100%;">ğŸ—‘ï¸ Delete All Data</button>
                </div>
            </div>

            <!-- PREMIUM TAB -->
            <div id="premium" class="section">
                <div class="card">
                    <h2>ğŸ’ Go Premium!</h2>
                    <p style="color: #666; margin-bottom: 20px;">Unlock exclusive features & support our mission!</p>

                    <div style="background: #f0f2f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px;">ğŸš€ Premium Features:</h3>
                        <ul style="margin-left: 20px; line-height: 2; color: #555;">
                            <li>ğŸ¤– AI-Powered Insights & Recommendations</li>
                            <li>ğŸ“ˆ Advanced Analytics & Reports</li>
                            <li>ğŸ‘¥ Community Features & Leaderboards</li>
                            <li>ğŸ”” Smart Reminders & Notifications</li>
                            <li>ğŸ“± Priority Mobile App Access</li>
                            <li>ğŸ¨ Custom Themes & Customization</li>
                            <li>â­ VIP Support</li>
                        </ul>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <strong>ğŸ’œ Limited Time Offer:</strong> â‚¹99/month (First 100 users get 50% off!)
                    </div>

                    <button class="btn-primary" onclick="startPayment()" id="subscribe-btn" style="width: 100%; padding: 15px; font-size: 1.1em; margin-bottom: 15px;">ğŸš€ Upgrade to Premium</button>

                    <p style="color: #999; font-size: 0.9em; text-align: center;">
                        ğŸ’œ Help us create the ultimate wellness platform!<br>
                        Cancel anytime, no questions asked.
                    </p>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer>
            <p>
                <a href="/ikigai-app/policies.html" target="_blank">Terms & Conditions</a> | 
                <a href="/ikigai-app/policies.html" target="_blank">Privacy Policy</a> | 
                <a href="/ikigai-app/policies.html" target="_blank">Refund Policy</a>
            </p>
            <p>Â© 2025 Ikigai Journey. All rights reserved. Made with ğŸ’œ for your wellness.</p>
        </footer>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <script src="firebase-config.js"></script>
    <script src="razorpay-config.js"></script>

    <script>
        let auth, db, userId = null, currentCategory = '';
        let activityChart, categoryChart;

        const quotes = [
            "The only way to do great work is to love what you do. - Steve Jobs",
            "Your time is limited, so don't waste it living someone else's life. - Steve Jobs",
            "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
            "It is during our darkest moments that we must focus to see the light. - Aristotle",
            "The only impossible journey is the one you never begin. - Tony Robbins",
            "In the middle of difficulty lies opportunity. - Albert Einstein",
            "Success is not final, failure is not fatal. - Winston Churchill",
            "Believe you can and you're halfway there. - Theodore Roosevelt"
        ];

        const achievements = [
            { id: 'first_log', name: 'ğŸ¯ First Step', desc: 'Log your first activity', unlocked: false },
            { id: 'five_logs', name: 'âš¡ Getting Started', desc: 'Complete 5 activities', unlocked: false },
            { id: 'week_streak', name: 'ğŸ”¥ Weekly Warrior', desc: 'Log activities for 7 consecutive days', unlocked: false },
            { id: 'hundred_mins', name: 'â±ï¸ Centaur', desc: 'Total 100 minutes logged', unlocked: false },
            { id: 'all_categories', name: 'ğŸ¨ Renaissance', desc: 'Log activities in all categories', unlocked: false }
        ];

        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                loadUserData();
                loadActivities();
                displayDailyQuote();
            } else {
                userId = null;
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        function signup() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                showMessage('âŒ Please enter email and password', 'error');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    showMessage('âœ… Account created! Welcome to Ikigai!', 'success');
                    document.getElementById('email-input').value = '';
                    document.getElementById('password-input').value = '';
                })
                .catch(error => {
                    showMessage('âŒ ' + error.message, 'error');
                });
        }

        function login() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                showMessage('âŒ Please enter email and password', 'error');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showMessage('âœ… Logged in successfully!', 'success');
                    document.getElementById('email-input').value = '';
                    document.getElementById('password-input').value = '';
                })
                .catch(error => {
                    showMessage('âŒ ' + error.message, 'error');
                });
        }

        function logout() {
            auth.signOut();
        }

        function showMessage(msg, type) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.innerHTML = `<div class="message ${type}">${msg}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        function selectCategory(cat, btn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentCategory = cat;
            document.getElementById('selected-category').value = cat;
        }

        async function saveIkigai(event) {
            event.preventDefault();
            if (!userId) return alert('You must be logged in!');

            const ikigaiData = {
                love: document.getElementById('love').value,
                good: document.getElementById('good').value,
                need: document.getElementById('need').value,
                paid: document.getElementById('paid').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').doc(userId).set({ ikigai: ikigaiData }, { merge: true });

                document.getElementById('ikigai-display').innerHTML = `
                    <strong>â¤ï¸ Your Passion:</strong> ${ikigaiData.love}<br><br>
                    <strong>â­ Your Talent:</strong> ${ikigaiData.good}<br><br>
                    <strong>ğŸŒ Your Mission:</strong> ${ikigaiData.need}<br><br>
                    <strong>ğŸ’¼ Your Vocation:</strong> ${ikigaiData.paid}
                `;
                document.getElementById('ikigai-result').style.display = 'block';

                alert('âœ… Ikigai saved to the cloud!');
            } catch (error) {
                alert('âŒ Error: ' + error.message);
            }
        }

        async function loadUserData() {
            if (!userId) return;

            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists && doc.data().ikigai) {
                    const ikigai = doc.data().ikigai;
                    document.getElementById('love').value = ikigai.love || '';
                    document.getElementById('good').value = ikigai.good || '';
                    document.getElementById('need').value = ikigai.need || '';
                    document.getElementById('paid').value = ikigai.paid || '';

                    document.getElementById('ikigai-display').innerHTML = `
                        <strong>â¤ï¸ Your Passion:</strong> ${ikigai.love}<br><br>
                        <strong>â­ Your Talent:</strong> ${ikigai.good}<br><br>
                        <strong>ğŸŒ Your Mission:</strong> ${ikigai.need}<br><br>
                        <strong>ğŸ’¼ Your Vocation:</strong> ${ikigai.paid}
                    `;
                    document.getElementById('ikigai-result').style.display = 'block';
                }

                updateStreakDisplay();
                updateProfileStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function addActivity() {
            if (!userId) return alert('You must be logged in!');

            const name = document.getElementById('activity-name').value;
            const duration = document.getElementById('activity-duration').value;
            const category = document.getElementById('selected-category').value;

            if (!name || !duration) {
                alert('âŒ Please fill all fields!');
                return;
            }

            try {
                await db.collection('users').doc(userId).collection('activities').add({
                    name: name,
                    duration: parseInt(duration),
                    category: category || 'Other',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('activity-name').value = '';
                document.getElementById('activity-duration').value = '';
                document.getElementById('selected-category').value = '';
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                
                loadActivities();
                updateStreakDisplay();
                alert('âœ… Activity logged!');
            } catch (error) {
                alert('âŒ Error: ' + error.message);
            }
        }

        async function loadActivities() {
            if (!userId) return;

            try {
                const snapshot = await db.collection('users').doc(userId).collection('activities')
                    .orderBy('createdAt', 'desc').limit(50).get();

                const activities = [];
                snapshot.forEach(doc => {
                    activities.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                const html = activities.map(activity => `
                    <div class="activity-item">
                        <div>
                            <strong>${activity.name}</strong>
                            <div style="font-size: 0.85em; color: #666;">â±ï¸ ${activity.duration} min | ğŸ“‚ ${activity.category || 'Other'}</div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('activities-list').innerHTML = html || '<p style="color: #999;">No activities yet. Start logging!</p>';

                // Update stats
                document.getElementById('activity-count').textContent = activities.length;
                const totalMins = activities.reduce((sum, a) => sum + a.duration, 0);
                document.getElementById('total-minutes').textContent = totalMins;
                document.getElementById('avg-activity').textContent = activities.length > 0
                    ? Math.round(totalMins / activities.length)
                    : 0;
                document.getElementById('daily-avg').textContent = activities.length > 0
                    ? Math.round(totalMins / Math.max(1, getDaysSinceMember()))
                    : 0;

                updateCharts(activities);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateCharts(activities) {
            // Category breakdown
            const categoryData = {};
            activities.forEach(a => {
                categoryData[a.category || 'Other'] = (categoryData[a.category || 'Other'] || 0) + a.duration;
            });

            if (categoryChart) categoryChart.destroy();
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: ['#667eea', '#764ba2', '#ff6b6b', '#51cf66', '#ffc107', '#00bcd4']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Weekly activity chart
            const weekData = Array(7).fill(0);
            activities.forEach(a => {
                const date = a.createdAt?.toDate?.() || new Date();
                const dayIndex = (6 - Math.floor((Date.now() - date) / 86400000)) % 7;
                if (dayIndex >= 0 && dayIndex < 7) {
                    weekData[dayIndex] += a.duration;
                }
            });

            if (activityChart) activityChart.destroy();
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    datasets: [{
                        label: 'Minutes',
                        data: weekData,
                        backgroundColor: '#667eea'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function displayDailyQuote() {
            const today = new Date().getDate();
            document.getElementById('daily-quote').textContent = quotes[today % quotes.length];
        }

        function getDaysSinceMember() {
            // Placeholder - can be enhanced to store join date
            return 1;
        }

        async function updateStreakDisplay() {
            // Calculate streak from activities
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            try {
                const snapshot = await db.collection('users').doc(userId).collection('activities').get();
                const activities = [];
                snapshot.forEach(doc => {
                    const date = doc.data().createdAt?.toDate?.() || new Date();
                    date.setHours(0, 0, 0, 0);
                    activities.push(date.getTime());
                });

                activities.sort((a, b) => b - a);

                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(currentDate);
                    checkDate.setDate(checkDate.getDate() - i);
                    if (activities.includes(checkDate.getTime())) {
                        streak++;
                    } else if (i > 0) {
                        break;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }

            document.getElementById('streak-display').textContent = `ğŸ”¥ Streak: ${streak}`;
            document.getElementById('profile-streak').textContent = streak;
            document.getElementById('profile-best').textContent = streak;
        }

        async function updateProfileStats() {
            const snapshot = await db.collection('users').doc(userId).collection('activities').get();
            const days = Math.ceil((Date.now() - auth.currentUser.metadata.creationTime) / 86400000);
            document.getElementById('profile-days').textContent = Math.max(1, days);
            document.getElementById('profile-badges').textContent = achievements.filter(a => a.unlocked).length;

            const achievementsHtml = achievements.map(a => `
                <div class="badge">${a.name}<br><small>${a.desc}</small></div>
            `).join('');
            document.getElementById('achievements-list').innerHTML = achievementsHtml || '<p style="color: #999;">Start logging to unlock achievements!</p>';
        }

        async function startPayment() {
            if (!userId) return alert('Please login first!');

            try {
                const options = {
                    key: RAZORPAY_KEY_ID,
                    amount: 9900,
                    currency: 'INR',
                    name: 'Ikigai Journey',
                    description: 'Premium Monthly Subscription',
                    handler: async function(response) {
                        await db.collection('users').doc(userId).set({
                            premium: true,
                            premiumSince: firebase.firestore.FieldValue.serverTimestamp(),
                            razorpayPaymentId: response.razorpay_payment_id
                        }, { merge: true });

                        alert('ğŸ‰ Welcome to Premium! Enjoy unlimited features!');
                        document.getElementById('subscribe-btn').disabled = true;
                        document.getElementById('subscribe-btn').textContent = 'âœ“ Premium Active';
                    },
                    prefill: {
                        email: document.getElementById('user-email').textContent
                    },
                    theme: { color: '#667eea' }
                };

                const rzp1 = new Razorpay(options);
                rzp1.open();
            } catch (error) {
                alert('âŒ Error: ' + error.message);
            }
        }

        async function exportData() {
            if (!userId) return alert('You must be logged in!');

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const activitiesSnapshot = await db.collection('users').doc(userId).collection('activities').get();

                const data = {
                    user: userDoc.data() || {},
                    activities: activitiesSnapshot.docs.map(doc => doc.data()),
                    exportDate: new Date().toLocaleString()
                };

                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ikigai-data-${new Date().toISOString().split('T')}.json`;
                a.click();

                alert('âœ… Your data has been downloaded!');
            } catch (error) {
                alert('âŒ Error: ' + error.message);
            }
        }

        async function deleteAllData() {
            if (!userId) return alert('You must be logged in!');
            if (!confirm('âš ï¸ Delete all data permanently?')) return;

            try {
                const batch = db.batch();
                const snapshot = await db.collection('users').doc(userId).collection('activities').get();
                snapshot.forEach(doc => batch.delete(doc.ref));
                batch.delete(db.collection('users').doc(userId));
                await batch.commit();

                alert('âœ… Data deleted.');
                logout();
            } catch (error) {
                alert('âŒ Error: ' + error.message);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
