<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ikigai Journey - Cloud Powered</title>
    <!-- Add other meta tags and manifest link here -->
    <style>
        /* Your existing CSS from Phase 2 */
        body { font-family: sans-serif; background: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; padding: 15px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .nav-tab { padding: 10px 15px; background: #e4e6eb; border: none; border-radius: 18px; font-weight: 600; cursor: pointer; }
        .nav-tab.active { background: #1877f2; color: white; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-primary { background: #1877f2; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .item-card { background: #f0f2f5; padding: 10px; border-radius: 8px; }
        #auth-screen, #app-screen { display: none; }
        #auth-screen.active, #app-screen.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Signup Screen -->
        <div id="auth-screen" class="active">
            <div class="card">
                <h2>Welcome to Ikigai Journey</h2>
                <p>Sign in to save your data to the cloud and access it from any device.</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email-input" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn-primary" onclick="signup()">Sign Up</button>
                <button onclick="login()">Login</button>
                <hr style="margin: 15px 0;">
                <button onclick="signInWithGoogle()">Sign In with Google</button>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="app-screen">
            <header>
                <h1>üå∏ Ikigai Journey</h1>
                <div>Welcome, <span id="user-email"></span>! <button onclick="logout()">Logout</button></div>
            </header>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('discover')">üéØ Discover</button>
                <button class="nav-tab" onclick="switchTab('today')">üìÖ Activity</button>
                <button class="nav-tab" onclick="switchTab('premium')">üíé Premium</button>
            </div>
            
            <div id="discover" class="section active card">
                <h2>Discover Your Ikigai</h2>
                <form onsubmit="saveIkigai(event)">
                    <div class="form-group"><label>‚ù§Ô∏è What you LOVE?</label><textarea id="love" required></textarea></div>
                    <div class="form-group"><label>‚≠ê What you're GOOD AT?</label><textarea id="good" required></textarea></div>
                    <div class="form-group"><label>üåç What the WORLD NEEDS?</label><textarea id="need" required></textarea></div>
                    <div class="form-group"><label>üí∞ What you can be PAID FOR?</label><textarea id="paid" required></textarea></div>
                    <button class="btn-primary" type="submit">Save Ikigai</button>
                </form>
            </div>

            <div id="today" class="section card" style="display: none;">
                <h2>Log Today's Activities</h2>
                <div class="item-grid" id="activityList"></div>
            </div>

            <div id="premium" class="section card" style="display: none;">
                <h2>üíé Go Premium!</h2>
                <p>Unlock advanced analytics, AI coaching, and more!</p>
                <button class="btn-primary" id="go-premium-btn">Upgrade Now ($10)</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let userId = null;

        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                userId = user.uid;
                document.getElementById('user-email').textContent = user.email;
                authScreen.classList.remove('active');
                appScreen.classList.add('active');
                loadUserData();
            } else {
                // User is signed out
                userId = null;
                authScreen.classList.add('active');
                appScreen.classList.remove('active');
            }
        });

        // Auth functions
        function signup() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => console.log('Signed up!', userCredential))
                .catch(error => alert(error.message));
        }

        function login() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => console.log('Logged in!', userCredential))
                .catch(error => alert(error.message));
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => console.log('Google sign-in success!', result))
                .catch(error => alert(error.message));
        }

        function logout() {
            auth.signOut().then(() => console.log('Logged out!'));
        }

        // Firestore functions
        async function saveIkigai(event) {
            event.preventDefault();
            if (!userId) return alert('You must be logged in!');
            
            const ikigaiData = {
                love: document.getElementById('love').value,
                good: document.getElementById('good').value,
                need: document.getElementById('need').value,
                paid: document.getElementById('paid').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('users').doc(userId).set({ ikigai: ikigaiData }, { merge: true });
            alert('Ikigai data saved to the cloud!');
        }

        async function loadUserData() {
            if (!userId) return;
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists && doc.data().ikigai) {
                const ikigai = doc.data().ikigai;
                document.getElementById('love').value = ikigai.love || '';
                document.getElementById('good').value = ikigai.good || '';
                document.getElementById('need').value = ikigai.need || '';
                document.getElementById('paid').value = ikigai.paid || '';
            }
        }
        
        // Push Notifications Setup
        function setupNotifications() {
            if ('serviceWorker' in navigator) {
                const messaging = firebase.messaging();
                Notification.requestPermission().then((permission) => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                        return messaging.getToken({ vapidKey: 'YOUR_VAPID_KEY_FROM_FIREBASE_SETTINGS' });
                    } else {
                        console.log('Unable to get permission to notify.');
                    }
                }).then(token => {
                    if (token) {
                        console.log('FCM Token:', token);
                        // Save the token to your server/database for this user
                        db.collection('users').doc(userId).set({ fcmToken: token }, { merge: true });
                    }
                }).catch(err => console.log('An error occurred while retrieving token. ', err));
            }
        }
        
        // Call this after user logs in
        auth.onAuthStateChanged(user => {
            if(user) {
                setupNotifications();
            }
        });

        // UI function
        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        }

    </script>
</body>
</html>

